################################################################################
# Copyright 2016 Indiana University
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
################################################################################

#' Runs all of the machine learning microbenchmarks
#'
#' \code{RunMachineLearningBenchmark} runs all of the microbenchmarks for
#'   performance testing machine learning functionality
#'
#' This function runs the machine learning microbenchmarks, which are divided
#' into four categories supported by this benchmark, defined in the
#' \code{clusteringMicrobenchmarks} input vector.  For each microbenchmark, it
#' creates a seperate output file in CSV format containing the performance
#' results for data set and function tested by the microbenchmark.  The names
#' of the output files follow the format
#' \code{csvResultsBaseFileName}_\code{runIdentifier}.csv, where
#' \code{csvResultsBaseFileName} is specified in the
#' \code{ClusteringMicrobenchmark} object of each microbenchmark and
#' \code{runIdentifier} is an input parameter to this function.  Each
#' input vector contains instances of the
#' \code{\link{ClusteringMicrobenchmark}} class defining each
#' microbenchmark.  Each microbenchmark object with the
#' \code{active} field set to TRUE will be executed.  The vectors of default
#' microbenchmarks are generated by the function
#' \code{\link{GetClusteringDefaultMicrobenchmarks}}.  Each 
#' \code{ClusteringMicrobenchmark} specifies an R data file which contains
#' the data object needed by the microbenchmark.  The needed R data
#' files should either be given in an attached R package or given in the
#' \code{data} subdirectory of the current working directory, and they should
#' have the extension \code{.RData}.
#'
#' @param runIdentifier a character string specifying the suffix to be
#'   appended to the base of the file name of the output CSV format files
#' @param resultsDirectory a character string specifying the directory
#'   where all of the CSV performance results files will be saved
#' @param clusteringMicrobenchmarks a vector of
#'   \code{ClusteringMicrobenchmark} objects defining the clustering
#'   microbenchmarks to execute as part of the machine learning benchmark.
#'   Default values are provided by the function
#'   \code{\link{GetClusteringDefaultMicrobenchmarks}}.
#' @return a list of data frames, one data frame for each supported
#'   category of machine learning microbenchmarks, with each data frame
#'   containing the user, system, and elapsed (wall clock) time of times of each
#'   performance trial
#'   
#' @examples 
#' ## Run the default machine learning microbenchmarks and place the results
#' ## files in the directory ./MachineLearningResults with the run identifier
#' ## test1 as a suffix to the base of the CSV file names
#' #RunMachineLearningBenchmark("test1", "./MachineLearningResults")
#'
#' ## Run the default clustering microbenchmarks with the
#' ## cluster_16_33_1213 microbenchmark disabled
#' #clusteringMicrobenchmarks <- GetClusteringDefaultMicrobenchmarks()
#' #clusteringMicrobenchmarks[["cluster_16_33_1213"]]$active <- FALSE
#' #RunMachineLearningBenchmark("test1", "./Results")
#' @seealso \code{\link{GetClusteringDefaultMicrobenchmarks}}
#' @export
RunMachineLearningBenchmark <- function(runIdentifier,
   resultsDirectory,
   clusteringMicrobenchmarks = GetClusteringDefaultMicrobenchmarks()) {

   numberOfThreads <- strtoi(GetConfigurableEnvParameter("R_BENCH_NUM_THREADS_VARIABLE"))

   allResults <- list()
   clusteringResults <- list()

   # Loop over all clustering microbenchmarks
   if (length(clusteringMicrobenchmarks) > 0) {
      clusteringResults <- PerformClusteringMicrobenchmarking(
         clusteringMicrobenchmarks, MicrobenchmarkClusteringKernel,
         numberOfThreads, runIdentifier, resultsDirectory)
   } else {
      cat(sprintf("WARN: no clustering microbenchmarks to execute, skipping\n\n"))
   }

   allResults[["clusteringResults"]] <- clusteringResults

   return(allResults)
}


#' Performs microbenchmarking of machine learning functions specified by an
#' input vector 
#' 
#' \code{PerformClusteringMicrobenchmarking} performs microbenchmarking
#' of machine learning functionality specified by the input vector of
#' \code{ClusteringMicrobenchmark} objects.  Objects with the \code{active}
#' flag set to TRUE indicate that the corresponding microbenchmark will be
#' performed; FALSE indicates that the microbenchmark will be skipped.
#'
#' @param microbenchmarks a vector of
#'   \code{ClusteringMicrobenchmark} objects defining the machine learning
#'   microbenchmarks to be executed as part of the machine learning
#'   benchmark.
#' @param microbenchmarkingFunction a function that performs the run time
#'   performance trials, computes the summary performance statistics, and
#'   writes the performance results to standard out, 
#' @param numberOfThreads the number of threads the microbenchmarks are
#'   intended to be executed with; the value is for display purposes only as
#'   the number of threads used is assumed to be controlled through environment
#'   variables
#' @param runIdentifier a character string specifying the suffix to be
#'   appended to the base of the file name of the output CSV format files
#' @param resultsDirectory a character string specifying the directory
#'   where all of the CSV performance results files will be saved
#' @return a data frame containing the benchmark name, user, system, and elapsed
#'   (wall clock) times of each performance trial each microbenchmark
PerformClusteringMicrobenchmarking <- function(microbenchmarks,
   microbenchmarkingFunction, numberOfThreads, runIdentifier,
   resultsDirectory) {

   microbenchmarkResults <- NULL

   if (length(microbenchmarks) > 0) {
      for (i in 1:length(microbenchmarks)) {
         if (microbenchmarks[[i]]$active) {

            benchmarkName <- microbenchmarks[[i]]$benchmarkName
            dataObjectName <- microbenchmarks[[i]]$dataObjectName

            # The data objects are read in to the global environment so that
            # they only have to be read from storage once.
            loadSuccessful <- tryCatch({
               if (!is.na(dataObjectName)) {
                  utils::data(list=c(dataObjectName))
               }

               TRUE
            }, warning = function(war) {
               msg <- sprintf("ERROR: data() threw a warning -- %s", war)
               write(msg, stderr())
               return(FALSE)
            }, error = function(err) {
               msg <- sprintf("ERROR: data() threw an error -- %s", err)
               write(msg, stderr())
               return(FALSE)
            })

            if (loadSuccessful) {
               resultsFrame <- microbenchmarkingFunction(microbenchmarks[[i]], numberOfThreads, resultsDirectory, runIdentifier)
               microbenchmarkResults <- rbind(microbenchmarkResults, resultsFrame)

               if (!is.na(dataObjectName)) {
                  remove(list=c(dataObjectName), envir=.GlobalEnv)
               }

               invisible(gc())
            } else {
               microbenchmarkResults[[benchmarkName]] <- NULL
               msg <- sprintf("ERROR: data() failed to read data object '%s', skipping microbenchmark '%s'",
                  dataObjectName, benchmarkName)
               write(msg, stderr())
            }
         }
      }
   }

   return (microbenchmarkResults)
}


#' Initializes the vector of default clustering microbenchmarks
#'
#' \code{GetClusteringDefaultMicrobenchmarks} defines the default clustering
#' microbenchmarks to be executed by the
#' \code{\link{RunMachineLearningBenchmark}} function.  The current clustering
#' microbenchmarks cover several data sets which are:
#' \enumerate{
#'    \item{pam_cluster_3_7_2500}{N=3, seven clusters with 2500 vectors per
#'      cluster}
#'    \item{pam_cluster_3_7_5000}{N=3, seven clusters with 5000 vectors per
#'      cluster}
#'    \item{pam_cluster_3_7_5715}{N=3, seven clusters with 5715 vectors per
#'      cluster}
#'    \item{pam_cluster_16_33_1213}{N=16, 33 clusters with 1213 vectors per
#'      cluster}
#'    \item{pam_cluster_64_33_1213}{N=64, 33 clusters with 1213 vectors per
#'      cluster}
#'    \item{pam_cluster_16_7_2858}{N=16, seven clusters with 2858 vectors per
#'      cluster}
#'    \item{pam_cluster_32_7_2858}{N=32, seven clusters with 2858 vectors per
#'      cluster}
#'    \item{pam_cluster_64_7_5715}{N=64, seven clusters with 5715 vectors per
#'      cluster}
#'    \item{clara_cluster_64_33_1213}{N=64, 33 clusters with 1213 vectors per
#'      cluster}
#'    \item{clara_cluster_1000_99_1000}{N=1000, 99 clusters with 1000 vectors
#'      per cluster} 
#' }
#' See the documentation for the
#' \code{\link{ClusteringMicrobenchmark}} class for more details.
#'
#' @return a vector of \code{ClusteringMicrobenchmark} objects defining the
#'   microbenchmarks to be executed.  The microbenchmarks appear in the order
#'   listed in the function description and are assigned the names enumerate
#'   in the description.
#' @family machine learning default microbenchmarks
#' @export
GetClusteringDefaultMicrobenchmarks <- function() {
   microbenchmarks <- list()
   microbenchmarks[["pam_cluster_3_7_2500"]] <- methods::new(
      "ClusteringMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_3_7_2500",
      benchmarkDescription = "Clustering of 17500 3-dimensional feature vectors into seven clusters using pam function",
      csvResultsBaseFileName = "pam_cluster_3_7_2500",
      dataObjectName = NA_character_,
      numberOfFeatures = as.integer(3),
      numberOfClusters = as.integer(7),
      numberOfFeatureVectorsPerCluster = as.integer(2500),
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   microbenchmarks[["pam_cluster_3_7_5000"]] <- methods::new(
      "ClusteringMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_3_7_5000",
      benchmarkDescription = "Clustering of 35000 3-dimensional feature vectors into seven clusters using pam function",
      csvResultsBaseFileName = "pam_cluster_3_7_5000",
      numberOfFeatures = as.integer(3),
      numberOfClusters = as.integer(7),
      numberOfFeatureVectorsPerCluster = as.integer(5000),
      dataObjectName = NA_character_,
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   microbenchmarks[["pam_cluster_3_7_5715"]] <- methods::new(
      "ClusteringMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_3_7_5715",
      benchmarkDescription = "Clustering of 40005 3-dimensional feature vectors into seven clusters using pam function",
      csvResultsBaseFileName = "pam_cluster_3_7_5715",
      numberOfFeatures = as.integer(3),
      numberOfClusters = as.integer(7),
      numberOfFeatureVectorsPerCluster = as.integer(5715),
      dataObjectName = NA_character_,
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   microbenchmarks[["pam_cluster_16_33_1213"]] <- methods::new(
      "ClusteringMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_16_33_1213",
      benchmarkDescription = "Clustering of 40029 16-dimensional feature vectors into 33 clusters using pam function",
      csvResultsBaseFileName = "pam_cluster_16_33_1213",
      numberOfFeatures = as.integer(16),
      numberOfClusters = as.integer(33),
      numberOfFeatureVectorsPerCluster = as.integer(1213),
      dataObjectName = NA_character_,
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   microbenchmarks[["pam_cluster_64_33_1213"]] <- methods::new(
      "ClusteringMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_64_33_1213",
      benchmarkDescription = "Clustering of 40029 64-dimensional feature vectors into 33 clusters using pam function",
      csvResultsBaseFileName = "pam_cluster_64_33_1213",
      numberOfFeatures = as.integer(64),
      numberOfClusters = as.integer(33),
      numberOfFeatureVectorsPerCluster = as.integer(1213),
      dataObjectName = NA_character_,
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   microbenchmarks[["pam_cluster_16_7_2858"]] <- methods::new(
      "ClusteringMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_16_7_2858",
      benchmarkDescription = "Clustering of 20006 16-dimensional feature vectors into seven clusters using pam function",
      csvResultsBaseFileName = "pam_cluster_16_7_2858",
      numberOfFeatures = as.integer(16),
      numberOfClusters = as.integer(7),
      numberOfFeatureVectorsPerCluster = as.integer(2858),
      dataObjectName = NA_character_,
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   microbenchmarks[["pam_cluster_32_7_2858"]] <- methods::new(
      "ClusteringMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_32_7_2858",
      benchmarkDescription = "Clustering of 20006 32-dimensional feature vectors into seven clusters using pam function",
      csvResultsBaseFileName = "pam_cluster_32_7_2858",
      numberOfFeatures = as.integer(32),
      numberOfClusters = as.integer(7),
      numberOfFeatureVectorsPerCluster = as.integer(2858),
      dataObjectName = NA_character_,
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   microbenchmarks[["pam_cluster_64_7_5715"]] <- methods::new(
      "ClusteringMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_64_7_5715",
      benchmarkDescription = "Clustering of 40005 64-dimensional feature vectors into seven clusters using pam function",
      csvResultsBaseFileName = "pam_cluster_64_7_5715",
      numberOfFeatures = as.integer(64),
      numberOfClusters = as.integer(7),
      numberOfFeatureVectorsPerCluster = as.integer(5715),
      dataObjectName = NA_character_,
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   microbenchmarks[["clara_cluster_64_33_1213"]] <- methods::new(
      "ClusteringMicrobenchmark",
      active = TRUE,
      benchmarkName = "clara_cluster_64_33_1213",
      benchmarkDescription = "Clustering of 40029 64-dimensional feature vectors into 33 clusters using clara function",
      csvResultsBaseFileName = "clara_cluster_64_33_1213",
      numberOfFeatures = as.integer(64),
      numberOfClusters = as.integer(33),
      numberOfFeatureVectorsPerCluster = as.integer(1213),
      dataObjectName = NA_character_,
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = ClaraClusteringBenchmark
   )

   microbenchmarks[["clara_cluster_1000_99_1000"]] <- methods::new(
      "ClusteringMicrobenchmark",
      active = TRUE,
      benchmarkName = "clara_cluster_1000_99_1000",
      benchmarkDescription = "Clustering of 99000 1000-dimensional feature vectors into 99 clusters using clara function",
      csvResultsBaseFileName = "clara_cluster_1000_99_1000",
      numberOfFeatures = as.integer(1000),
      numberOfClusters = as.integer(90),
      numberOfFeatureVectorsPerCluster = as.integer(1000),
      dataObjectName = NA_character_,
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = ClaraClusteringBenchmark
   )

   return (microbenchmarks)
}


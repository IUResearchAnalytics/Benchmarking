################################################################################
# Copyright 2016 Indiana University
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
################################################################################

#' Runs all of the machine learning microbenchmarks
#'
#' \code{MachineLearningBenchmark} runs all of the microbenchmarks for
#'   performance testing machine learning functionality
#'
#' This function runs the machine learning microbenchmarks, which are divided
#' into four categories supported by this benchmark, defined in the
#' \code{clusteringMicrobenchmarks} input vector.  For each microbenchmark, it
#' creates a seperate output file in CSV format containing the performance
#' results for data set and function tested by the microbenchmark.  The names
#' of the output files follow the format
#' \code{csvResultsBaseFileName}_\code{runIdentifier}.csv, where
#' \code{csvResultsBaseFileName} is specified in the
#' \code{MachineLearningMicrobenchmark} object of each microbenchmark and
#' \code{runIdentifier} is an input parameter to this function.  Each
#' input vector contains instances of the
#' \code{\link{MachineLearningMicrobenchmark}} class defining each
#' microbenchmark.  Each microbenchmark object with the
#' \code{active} field set to TRUE will be executed.  The vectors of default
#' microbenchmarks are generated by the function
#' \code{\link{ClusteringDefaultMicrobenchmarks}}.  Each 
#' \code{MachineLearningMicrobenchmark} specifies an R data file which contains
#' the data object needed by the microbenchmark.  The needed R data
#' files should either be given in an attached R package or given in the
#' \code{data} subdirectory of the current working directory, and they should
#' have the extension \code{.RData}.
#'
#' @param runIdentifier a character string specifying the suffix to be
#'   appended to the base of the file name of the output CSV format files
#' @param resultsDirectory a character string specifying the directory
#'   where all of the CSV performance results files will be saved
#' @param clusteringMicrobenchmarks a vector of
#'   \code{MachineLearningMicrobenchmark} objects defining the clustering
#'   microbenchmarks to execute as part of the machine learning benchmark.
#'   Default values are provided by the function
#'   \code{\link{ClusteringDefaultMicrobenchmarks}}.
#' @return a list of lists of data frames, one sublist for each supported
#'   category of machine learning microbenchmarks, with each data frame
#'   containing the user, system, and elapsed (wall clock) time of times of each
#'   performance trial used to compute the average performance 
#'   
#' @examples 
#' ## Run the default machine learning microbenchmarks and place the results
#' ## files in the directory ./MachineLearningResults with the run identifier
#' ## test1 as a suffix to the base of the CSV file names
#' #MachineLearningBenchmark("test1", "./MachineLearningResults")
#'
#' ## Run the default clustering microbenchmarks with the xx microbenchmark
#' ## disabled
#' #clusteringMicrobenchmarks <- ClusteringDefaultMicrobenchmarks()
#' #clusteringMicrobenchmarks[["cluster_16_33_1213"]]$active <- FALSE
#' #MachineLearningBenchmark("test1", "./Results")
#' @seealso \code{\link{ClusteringDefaultMicrobenchmarks}}
#' @export
MachineLearningBenchmark <- function(runIdentifier,
   resultsDirectory,
   clusteringMicrobenchmarks = ClusteringDefaultMicrobenchmarks()) {

   numberOfThreads <- strtoi(GetConfigurableEnvParameter("R_BENCH_NUM_THREADS_VARIABLE"))

   allResults <- list()
   clusteringResults <- list()

   # Loop over all clustering microbenchmarks
   if (length(clusteringMicrobenchmarks) > 0) {
      clusteringResults <- PerformMachineLearningMicrobenchmarking(
         clusteringMicrobenchmarks, numberOfThreads, runIdentifier,
         resultsDirectory)
   } else {
      cat(sprintf("WARN: no clustering microbenchmarks to execute, skipping\n\n"))
   }

   allResults[["clusteringResults"]] <- clusteringResults

   return(allResults)
}


#' Performs microbenchmarking of machine learning functions specified by an
#' input vector 
#' 
#' \code{PerformMachineLearningMicrobenchmarking} performs microbenchmarking
#' of machine learning functionality specified by the input vector of
#' \code{MachineLearningMicrobenchmark} objects.  Objects with the \code{active}
#' flag set to TRUE indicate that the corresponding microbenchmark will be
#' performed; FALSE indicates that the microbenchmark will be skipped.
#'
#' @param microbenchmarks a vector of
#'   \code{MachineLearningMicrobenchmark} objects defining the machine learning
#'   microbenchmarks to be executed as part of the machine learning
#'   benchmark.
#' @param numberOfThreads the number of threads the microbenchmarks are
#'   intended to be executed with; the value is for display purposes only as
#'   the number of threads used is assumed to be controlled through environment
#'   variables
#' @param runIdentifier a character string specifying the suffix to be
#'   appended to the base of the file name of the output CSV format files
#' @param resultsDirectory a character string specifying the directory
#'   where all of the CSV performance results files will be saved
#' @return a list of data frames, one per microbenchmark, each containing the
#'   user, system, and elapsed (wall clock) times of each performance trial
#'   used to compute the average performance
PerformMachineLearningMicrobenchmarking <- function(microbenchmarks,
   numberOfThreads, runIdentifier, resultsDirectory) {

   microbenchmarkResults <- list()

   if (length(microbenchmarks) > 0) {
      for (i in 1:length(microbenchmarks)) {
         if (microbenchmarks[[i]]$active) {

            benchmarkName <- microbenchmarks[[i]]$benchmarkName
            dataObjectName <- microbenchmarks[[i]]$dataObjectName

            # The data objects are read in to the global environment so that
            # they only have to be read from storage once.
            loadSuccessful <- tryCatch({
               utils::data(list=c(dataObjectName))
               TRUE
            }, warning = function(war) {
               msg <- sprintf("ERROR: data() threw a warning -- %s", war)
               write(msg, stderr())
               return(FALSE)
            }, error = function(err) {
               msg <- sprintf("ERROR: data() threw an error -- %s", err)
               write(msg, stderr())
               return(FALSE)
            })

            if (loadSuccessful) {
               microbenchmarkResults[[benchmarkName]] <- MicrobenchmarkMachineLearningKernel(microbenchmarks[[i]], numberOfThreads, resultsDirectory, runIdentifier)
               remove(list=c(dataObjectName), envir=.GlobalEnv)
               invisible(gc())
            } else {
               microbenchmarkResults[[benchmarkName]] <- NULL
               msg <- sprintf("ERROR: data() failed to read data object '%s', skipping microbenchmark '%s'",
                  microbenchmarks[[i]]$dataObjectName,
                  microbenchmarks[[i]]$benchmarkName)
               write(msg, stderr())
            }
         }
      }
   }

   return (microbenchmarkResults)
}


#' Initializes the vector of default clustering microbenchmarks
#'
#' \code{ClusteringDefaultMicrobenchmarks} defines the default clustering
#' microbenchmarks to be executed by the \code{\link{MachineLearningBenchmark}}
#' function.  The current clustering microbenchmarks cover several data sets
#' which are:
#' \enumerate{
#'    \item{cluster_3_7_2500}{N=3, seven clusters with 2500 vectors per cluster}
#'    \item{cluster_3_7_5000}{N=3, seven clusters with 5000 vectors per cluster}
#'    \item{cluster_3_7_5715}{N=3, seven clusters with 5715 vectors per cluster}
#'    \item{cluster_16_33_1213}{N=16, 33 clusters with 1213 vectors per cluster}
#'    \item{cluster_64_33_1213}{N=64, 33 clusters with 1213 vectors per cluster}
#'    \item{cluster_16_7_2858}{N=16, seven clusters with 2858 vectors per
#'      cluster}
#'    \item{cluster_32_7_2858}{N=32, seven clusters with 2858 vectors per
#'      cluster}
#'    \item{cluster_64_7_5715}{N=64, seven clusters with 5715 vectors per
#'      cluster}
#' }
#' See the documentation for the
#' \code{\link{MachineLearningMicrobenchmark}} class for more details.
#'
#' @return a vector of \code{MachineLearningMicrobenchmark} objects defining the
#'   microbenchmarks to be executed.  The microbenchmarks appear in the order
#'   listed in the function description and are assigned the names enumerate
#'   in the description.
#' @family machine learning default microbenchmarks
#' @export
ClusteringDefaultMicrobenchmarks <- function() {
   microbenchmarks <- list()
   microbenchmarks[["pam_cluster_3_7_2500"]] <- methods::new(
      "MachineLearningMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_3_7_2500",
      benchmarkDescription = "Clustering of 17500 3-dimensional feature vectors into seven clusters using pam function",
      dataFileName = "cluster_3_7_2500",
      csvResultsBaseFileName = "pam_cluster_3_7_2500",
      dataObjectName = "cluster_3_7_2500",
      numberOfTrials = as.integer(2),
      numberOfWarmupTrials = as.integer(0),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   microbenchmarks[["pam_cluster_3_7_5000"]] <- methods::new(
      "MachineLearningMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_3_7_5000",
      benchmarkDescription = "Clustering of 35000 3-dimensional feature vectors into seven clusters using pam function",
      dataFileName = "cluster_3_7_5000",
      csvResultsBaseFileName = "pam_cluster_3_7_5000",
      dataObjectName = "cluster_3_7_5000",
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   microbenchmarks[["pam_cluster_3_7_5715"]] <- methods::new(
      "MachineLearningMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_3_7_5715",
      benchmarkDescription = "Clustering of 40005 3-dimensional feature vectors into seven clusters using pam function",
      dataFileName = "cluster_3_7_5715",
      csvResultsBaseFileName = "pam_cluster_3_7_5715",
      dataObjectName = "cluster_3_7_5715",
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   microbenchmarks[["pam_cluster_16_33_1213"]] <- methods::new(
      "MachineLearningMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_16_33_1213",
      benchmarkDescription = "Clustering of 40029 16-dimensional feature vectors into 33 clusters using pam function",
      dataFileName = "cluster_16_33_1213",
      csvResultsBaseFileName = "pam_cluster_16_33_1213",
      dataObjectName = "cluster_16_33_1213",
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   microbenchmarks[["pam_cluster_64_33_1213"]] <- methods::new(
      "MachineLearningMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_64_33_1213",
      benchmarkDescription = "Clustering of 40029 64-dimensional feature vectors into 33 clusters using pam function",
      dataFileName = "cluster_64_33_1213",
      csvResultsBaseFileName = "pam_cluster_64_33_1213",
      dataObjectName = "cluster_64_33_1213",
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   microbenchmarks[["pam_cluster_16_7_2858"]] <- methods::new(
      "MachineLearningMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_16_7_2858",
      benchmarkDescription = "Clustering of 20006 16-dimensional feature vectors into seven clusters using pam function",
      dataFileName = "cluster_16_7_2858",
      csvResultsBaseFileName = "pam_cluster_16_7_2858",
      dataObjectName = "cluster_16_7_2858",
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   microbenchmarks[["pam_cluster_32_7_2858"]] <- methods::new(
      "MachineLearningMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_32_7_2858",
      benchmarkDescription = "Clustering of 20006 32-dimensional feature vectors into seven clusters using pam function",
      dataFileName = "cluster_32_7_2858",
      csvResultsBaseFileName = "pam_cluster_32_7_2858",
      dataObjectName = "cluster_32_7_2858",
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   microbenchmarks[["pam_cluster_64_7_5715"]] <- methods::new(
      "MachineLearningMicrobenchmark",
      active = TRUE,
      benchmarkName = "pam_cluster_64_7_5715",
      benchmarkDescription = "Clustering of 40005 64-dimensional feature vectors into seven clusters using pam function",
      dataFileName = "cluster_64_7_5715",
      csvResultsBaseFileName = "pam_cluster_64_7_5715",
      dataObjectName = "cluster_64_7_5715",
      numberOfTrials = as.integer(3),
      numberOfWarmupTrials = as.integer(1),
      allocatorFunction = ClusteringAllocator,
      benchmarkFunction = PamClusteringBenchmark
   )

   return (microbenchmarks)
}

